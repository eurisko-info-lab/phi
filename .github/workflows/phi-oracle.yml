name: Phi Oracle

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]
  discussion:
    types: [created]
  discussion_comment:
    types: [created]

jobs:
  respond:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.issue.body || github.event.comment.body || github.event.discussion.body, '@phi') ||
      contains(github.event.issue.title || '', '@phi')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install anthropic
      
      - name: Generate Phi Response
        id: phi
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python << 'PYTHON'
          import os
          import json
          import anthropic
          from pathlib import Path
          
          # Get the question
          event = json.loads(open(os.environ['GITHUB_EVENT_PATH']).read())
          
          body = event.get('issue', {}).get('body', '') or \
                 event.get('comment', {}).get('body', '') or \
                 event.get('discussion', {}).get('body', '')
          
          title = event.get('issue', {}).get('title', '') or \
                  event.get('discussion', {}).get('title', '')
          
          question = f"{title} {body}".strip()
          
          # Check if this is a spec generation request
          spec_triggers = ['good parts', 'spec for', 'create', 'generate', 'what is', 'how to']
          is_spec_request = any(t in question.lower() for t in spec_triggers)
          
          client = anthropic.Anthropic()
          
          if is_spec_request and len(question) > 20:
              # Generate a full Phi spec
              system = """You are Phi, the meta-language oracle. Generate a Phi specification.
          
          Phi syntax:
          - Type declarations: `Type = Constructor : Params`  
          - Functions: `name : Type = implementation`
          - Dependent types: `Vec : (n : Nat) â†’ Type â†’ Type`
          - Pattern matching with `|`
          - Comments with `--`
          
          Return JSON:
          {
            "name": "filename_without_phi",
            "title": "Human readable title",
            "summary": "One paragraph",
            "highlights": ["Point 1", "Point 2", "Point 3"],
            "content": "-- The .phi file content"
          }"""
              
              response = client.messages.create(
                  model="claude-sonnet-4-20250514",
                  max_tokens=6000,
                  system=system,
                  messages=[{"role": "user", "content": question}]
              )
              
              text = response.content[0].text
              if "```json" in text:
                  text = text.split("```json")[1].split("```")[0]
              elif "```" in text:
                  text = text.split("```")[1].split("```")[0]
              
              try:
                  spec = json.loads(text.strip())
                  
                  # Write the spec file
                  spec_path = Path(f"specs/phi-core/examples/languages/{spec['name']}.phi")
                  spec_path.parent.mkdir(parents=True, exist_ok=True)
                  
                  header = f"-- {spec['title']}\n-- Generated by Phi Oracle\n--\n"
                  for h in spec['highlights']:
                      header += f"-- â€¢ {h}\n"
                  header += "--\n\n"
                  
                  spec_path.write_text(header + spec['content'])
                  
                  # Output for next step
                  print(f"SPEC_GENERATED=true")
                  print(f"SPEC_NAME={spec['name']}")
                  print(f"SPEC_TITLE={spec['title']}")
                  print(f"SPEC_SUMMARY={spec['summary'][:200]}")
                  
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"generated=true\n")
                      f.write(f"name={spec['name']}\n")
                      f.write(f"title={spec['title']}\n")
                      f.write(f"path=specs/phi-core/examples/languages/{spec['name']}.phi\n")
                  
                  # Format reply
                  highlights = '\n'.join(f'â€¢ {h}' for h in spec['highlights'])
                  reply = f"""ðŸ”® **Phi Oracle has spoken!**

          **{spec['title']}**

          {spec['summary']}

          **Highlights:**
          {highlights}

          ðŸ“œ I've generated `{spec['name']}.phi` - see the commit below!

          *Grammar = Implementation. The spec is the program.*"""
                  
                  with open('response.md', 'w') as f:
                      f.write(reply)
                      
              except json.JSONDecodeError:
                  # Fall back to simple response
                  with open('response.md', 'w') as f:
                      f.write(f"ðŸ”® {response.content[0].text[:1500]}")
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write("generated=false\n")
          else:
              # Simple response
              response = client.messages.create(
                  model="claude-sonnet-4-20250514",
                  max_tokens=2000,
                  system="You are Phi, a meta-language where grammar=implementation. Answer concisely about type theory, programming languages, and Phi concepts.",
                  messages=[{"role": "user", "content": question}]
              )
              
              with open('response.md', 'w') as f:
                  f.write(f"ðŸ”® {response.content[0].text}")
              
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("generated=false\n")
          PYTHON
      
      - name: Commit Generated Spec
        if: steps.phi.outputs.generated == 'true'
        run: |
          git config user.name "Phi Oracle"
          git config user.email "phi@eurisko.info"
          git add "specs/phi-core/examples/languages/${{ steps.phi.outputs.name }}.phi"
          git commit -m "âœ¨ ${{ steps.phi.outputs.title }}"
          git push
      
      - name: Post Response
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const response = fs.readFileSync('response.md', 'utf8');
            
            const context = require('@actions/github').context;
            
            if (context.eventName === 'issues' || context.eventName === 'issue_comment') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: response
              });
            } else if (context.eventName.startsWith('discussion')) {
              // For discussions, use GraphQL
              const discussionId = context.payload.discussion?.node_id;
              if (discussionId) {
                await github.graphql(`
                  mutation($discussionId: ID!, $body: String!) {
                    addDiscussionComment(input: {discussionId: $discussionId, body: $body}) {
                      comment { id }
                    }
                  }
                `, { discussionId, body: response });
              }
            }
      
      - name: Announce on Twitter
        if: steps.phi.outputs.generated == 'true'
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          if [ -n "$TWITTER_API_KEY" ]; then
            pip install tweepy
            python << PYTHON
          import os
          import tweepy
          
          client = tweepy.Client(
              consumer_key=os.environ['TWITTER_API_KEY'],
              consumer_secret=os.environ['TWITTER_API_SECRET'],
              access_token=os.environ['TWITTER_ACCESS_TOKEN'],
              access_token_secret=os.environ['TWITTER_ACCESS_SECRET']
          )
          
          title = "${{ steps.phi.outputs.title }}"
          name = "${{ steps.phi.outputs.name }}"
          url = f"https://github.com/eurisko-info-lab/phi/blob/main/specs/phi-core/examples/languages/{name}.phi"
          
          tweet = f"""ðŸ”® New Phi Spec: {title}
          
          Grammar = Implementation
          One spec â†’ all platforms
          
          {url}
          
          #PhiLang #TypeTheory"""
          
          client.create_tweet(text=tweet[:280])
          print("âœ… Tweeted announcement")
          PYTHON
          fi
